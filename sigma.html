<!doctype html>
<html lang="pt-BR">
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="SIGMA">
<link rel="apple-touch-icon" href="logo-192.png">

<link rel="manifest" href="manifest.json">
<title>SIGMA — Guia de Estudos</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<script>
const token = localStorage.getItem("google_access_token");
if (!token) {
  location.replace("index.html");
}
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
</script>

<style>
:root{
  --blue:#0b5ea8;
  --blue-dark:#0a4f8d;
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --radius:18px;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Roboto',sans-serif;background:var(--bg);color:var(--text)}

.header{
  background:#fff;margin:16px;padding:14px 18px;border-radius:var(--radius);
  display:flex;align-items:center;justify-content:space-between
}
.logo{width:34px;height:34px;border-radius:8px;object-fit:contain;background:#eef2f7}
.status{font-size:13px;color:#374151}

.app{display:grid;grid-template-columns:280px 1fr;gap:20px;padding:0 16px 16px}
.sidebar{background:#fff;border-radius:var(--radius);padding:16px}
.course{
  padding:10px 12px;border-radius:12px;cursor:pointer;margin-bottom:8px;
  transition:.2s
}
.course.active{
  background:linear-gradient(90deg,var(--blue),var(--blue-dark));
  color:#fff
}

.main{display:flex;flex-direction:column;gap:16px}
.card{background:#fff;border-radius:var(--radius);padding:20px}

.course-head{display:flex;justify-content:space-between;align-items:center}
.course-title{font-size:20px;font-weight:500}
.course-sub{font-size:13px;color:var(--muted)}

.materias-head{display:flex;justify-content:space-between;margin-bottom:12px}

.materia{
  background:linear-gradient(180deg,#ffffff,#f1f6ff);
  border-radius:16px;
  padding:18px 16px 18px 26px;
  margin-bottom:12px;
  position:relative;
  border:1px solid #e2e8f0;
  box-shadow:0 6px 16px rgba(0,0,0,.04)
}

.materia::before{
  content:"";
  position:absolute;
  left:12px;top:14px;bottom:14px;
  width:8px;border-radius:6px;
  background:var(--blue)
}
.materia-head{
  display:flex;justify-content:space-between;align-items:center;
  cursor:pointer
}
.materia-left{display:flex;flex-direction:column}
.materia-title{font-weight:700}
.materia-meta{font-size:13px;color:var(--muted)}
.materia-right{display:flex;align-items:center;gap:10px}

.assuntos{display:none;margin-top:12px}
.assuntos.open{display:block}

.assunto{
  display:flex;align-items:center;gap:10px;padding:6px 0
}
.check{
  width:24px;height:24px;border-radius:7px;
  background:#e5e7eb;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:14px
}
.check.mid{background:#93c5fd;color:#1e3a8a}
.check.done{background:var(--blue);color:#fff}

.btn{
  background:var(--blue);color:#fff;
  border:none;border-radius:10px;
  padding:8px 12px;cursor:pointer
}
.btn-light{background:#e5e7eb;color:#111}
.btn-danger{background:#dc2626;color:#fff}

.flash-btn{
  background:none;border:none;
  cursor:pointer;color:var(--muted);
  font-size:14px
}

.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center;
  z-index:999
}
.modal .box{
  background:#fff;border-radius:16px;
  padding:16px;width:440px;max-width:95%
}

@media(max-width:900px){
  .app{grid-template-columns:1fr}
  .sidebar{order:2}
  .main{order:3}
}
</style>
</head>

<body>

<div class="header">
  <div style="display:flex;gap:12px;align-items:center">
    <img src="logo-192.png" class="logo">
    <div>
      <strong>SIGMA</strong><br>
      <span class="status">Google Sheets conectado</span>
    </div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn" onclick="openAdmin()">Admin</button>
    <button class="btn btn-outline" onclick="logout()">Sair</button>
  </div>
</div>

<div class="app">
  <aside class="sidebar">
    <strong>Plano de Estudos</strong>
    <div id="courseList"></div>
  </aside>

  <main class="main">
    <div class="card">
      <div class="course-head">
        <div>
          <div class="course-title" id="courseTitle">Selecione um curso</div>
          <div class="course-sub">Clique na matéria para expandir</div>
        </div>
        <div style="text-align:center">
          <svg width="110" height="110" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="52" stroke="#e5e7eb" stroke-width="12" fill="none"/>
            <circle id="ringBar" cx="60" cy="60" r="52"
              stroke="var(--blue)" stroke-width="12" fill="none"
              stroke-dasharray="326.7" stroke-dashoffset="326.7"
              transform="rotate(-90 60 60)"/>
            <text id="ringText" x="60" y="66" text-anchor="middle" font-size="18">0%</text>
          </svg>
          <div class="course-sub" id="globalText">Progresso geral: 0%</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="materias-head">
        <strong>Matérias</strong>
        <span class="course-sub">Clique para expandir</span>
      </div>
      <div id="subjectList"></div>
    </div>
  </main>
</div>

<script>
/* BASE */
const SHEET_ID="1eDylSUunRKeUXVq6lpJ8fbK4iFpK1WQgcPyEBAUEMf4";
const RANGE="dados!A:F";
const ADMIN_EMAIL="kaiqueizaque2@gmail.com";

const email=localStorage.getItem("user_email");
let rows=[],activeCourse=null,openMateria=null;

const headers=()=>({Authorization:"Bearer "+token});

/* LOAD */
async function loadData(){
  const r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}`,{headers:headers()});
  const j=await r.json();
  rows=[];
  (j.values||[]).slice(1).forEach((v,i)=>{
    rows.push({
      curso:v[1],
      materia:v[2],
      assunto:v[3],
      flashcard:v[4]||"",
      status:Number(v[5])||0
    });
  });
  render();
}

/* RENDER */
function render(){
  courseList.innerHTML="";
  subjectList.innerHTML="";
  const cursos={};

  rows.forEach(r=>{
    cursos[r.curso]??={};
    cursos[r.curso][r.materia]??=[];
    cursos[r.curso][r.materia].push(r);
  });

  Object.keys(cursos).forEach(c=>{
    const d=document.createElement("div");
    d.className="course"+(c===activeCourse?" active":"");
    d.textContent=c;
    d.onclick=()=>{activeCourse=c;openMateria=null;render()};
    courseList.appendChild(d);
  });

  if(!activeCourse) return;
  courseTitle.textContent=activeCourse;
}

loadData();

function logout(){
  localStorage.removeItem("google_access_token");
  localStorage.removeItem("user_email");
  location.replace("index.html");
}
</script>

</body>
</html>
