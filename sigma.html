<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<title>SIGMA ‚Äî Guia de Estudos</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<script>
if(!localStorage.getItem("google_access_token")){
  location.replace("index.html");
}

</script>

</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</script>

<style>
  
:root{
  --blue:#0b5ea8;
  --blue-dark:#0a4f8d;
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --radius:18px;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Roboto',sans-serif;background:var(--bg);color:var(--text)}

.header{
  background:#fff;margin:16px;padding:14px 18px;border-radius:var(--radius);
  display:flex;align-items:center;justify-content:space-between
}
.logo{width:34px;height:34px;border-radius:8px;object-fit:contain;background:#eef2f7}
.status{font-size:13px;color:#374151}

.app{display:grid;grid-template-columns:280px 1fr;gap:20px;padding:0 16px 16px}
.sidebar{background:#fff;border-radius:var(--radius);padding:16px}
.course{
  padding:10px 12px;border-radius:12px;cursor:pointer;margin-bottom:8px;
  transition:.2s
}
.course.active{
  background:linear-gradient(90deg,var(--blue),var(--blue-dark));
  color:#fff
}

.main{display:flex;flex-direction:column;gap:16px}
.card{background:#fff;border-radius:var(--radius);padding:20px}

.course-head{display:flex;justify-content:space-between;align-items:center}
.course-title{font-size:20px;font-weight:500}
.course-sub{font-size:13px;color:var(--muted)}

.materias-head{display:flex;justify-content:space-between;margin-bottom:12px}

.materia{
  background:linear-gradient(180deg,#ffffff,#f1f6ff);
  border-radius:16px;
  padding:18px 16px 18px 26px;
  margin-bottom:12px;
  position:relative;
  border:1px solid #e2e8f0;
  box-shadow:0 6px 16px rgba(0,0,0,.04)
}

.materia::before{
  content:"";
  position:absolute;
  left:12px;top:14px;bottom:14px;
  width:8px;border-radius:6px;
  background:var(--blue)
}
.materia-head{
  display:flex;justify-content:space-between;align-items:center;
  cursor:pointer
}
.materia-left{display:flex;flex-direction:column}
.materia-title{font-weight:700}
.materia-meta{font-size:13px;color:var(--muted)}
.materia-right{display:flex;align-items:center;gap:10px}

.assuntos{display:none;margin-top:12px}
.assuntos.open{display:block}

.assunto{
  display:flex;align-items:center;gap:10px;padding:6px 0
}
.check{
  width:24px;height:24px;border-radius:7px;
  background:#e5e7eb;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:14px
}
.check.mid{background:#93c5fd;color:#1e3a8a}
.check.done{background:var(--blue);color:#fff}

.btn{
  background:var(--blue);color:#fff;
  border:none;border-radius:10px;
  padding:8px 12px;cursor:pointer
}
.btn-light{background:#e5e7eb;color:#111}
.btn-danger{background:#dc2626;color:#fff}

.flash-btn{
  background:none;border:none;
  cursor:pointer;color:var(--muted);
  font-size:14px
}

.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center;
  z-index:999
}
.modal .box{
  background:#fff;border-radius:16px;
  padding:16px;width:440px;max-width:95%
}
textarea{
  width:100%;min-height:120px;
  border-radius:12px;border:1px solid #cbd5e1;
  padding:10px
}
select,input{
  padding:8px;border-radius:10px;
  border:1px solid #cbd5e1;width:100%
}
.admin-row{display:flex;gap:8px;margin-bottom:8px}
.order-btn{padding:4px 8px}

@media(max-width:900px){
  .app{
    grid-template-columns:1fr;
  }

  .sidebar{
    order:2;
  }

  .main{
    order:3;
  }

  .course-head{
    flex-direction:row;
    gap:12px;
    align-items:center;
  }

  svg{
    width:80px;
    height:80px;
  }
}

@media (max-width: 768px){

  .header{
    flex-direction:row;
    align-items:center;
    justify-content:space-between;
    margin:12px;
  }

  .app{
    grid-template-columns:1fr;
  }

  .sidebar{
    width:100%;
    margin:0;
  }

  .course{
    text-align:center;
  }

  .course-head{
    flex-direction:row;
    align-items:center;
    gap:12px;
  }

  svg{
    width:80px;
    height:80px;
  }
}

#ringBar{
  transition: stroke-dashoffset 0.6s ease;
}

.header-actions{
  display:flex;
  gap:8px;
  align-items:center;
}

.btn-outline{
  background:#fff;
  color:var(--blue);
  border:1px solid var(--blue);
}

.btn-outline:hover{
  background:var(--blue);
  color:#fff;
}

</style>
</head>

<body>

<div class="header">
  <div style="display:flex;gap:12px;align-items:center">
    <img src="logo.png" class="logo">
    <div>
      <strong>SIGMA</strong><br>
      <span class="status">Google Sheets conectado</span>
    </div>
  </div>

  <!-- üîµ ESTE BLOCO √â O √öNICO NOVO -->
  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn" onclick="openAdmin()">Admin</button>
    <button class="btn btn-outline" onclick="logout()">Sair</button>
  </div>
</div>


<div class="app">
  <aside class="sidebar">
    <strong>Plano de Estudos</strong>
    <div id="courseList"></div>
  </aside>

  <main class="main">
    <div class="card">
      <div class="course-head">
        <div>
          <div class="course-title" id="courseTitle">Selecione um curso</div>
          <div class="course-sub">Clique na mat√©ria para expandir</div>
        </div>
        <div style="text-align:center">
          <svg width="110" height="110" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="52" stroke="#e5e7eb" stroke-width="12" fill="none"/>
            <circle id="ringBar" cx="60" cy="60" r="52"
              stroke="var(--blue)" stroke-width="12" fill="none"
              stroke-dasharray="326.7" stroke-dashoffset="326.7"
              transform="rotate(-90 60 60)"/>
            <text id="ringText" x="60" y="66" text-anchor="middle" font-size="18">0%</text>
          </svg>
          <div class="course-sub" id="globalText">Progresso geral: 0%</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="materias-head">
        <strong>Mat√©rias</strong>
        <span class="course-sub">Clique para expandir</span>
      </div>
      <div id="subjectList"></div>
    </div>
  </main>
</div>

<!-- FLASH ASSUNTO -->
<div class="modal" id="flashModal">
  <div class="box">
    <h3>üìù Flash Card</h3>
    <textarea id="flashText"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn-light" onclick="closeFlash()">Fechar</button>
      <button class="btn" onclick="saveFlash()">Salvar</button>
    </div>
  </div>
</div>

<!-- FLASH MAT√âRIA -->
<div class="modal" id="flashMatModal">
  <div class="box">
    <h3 id="flashMatTitle">üìò Flash Cards</h3>
    <div id="flashMatText" style="min-height:120px;margin:12px 0"></div>
    <div style="display:flex;justify-content:space-between">
      <button class="btn-light" onclick="prevFlash()">‚óÄ</button>
      <button class="btn-light" onclick="nextFlash()">‚ñ∂</button>
    </div>
    <div style="text-align:right;margin-top:8px">
      <button class="btn" onclick="closeFlashMat()">Fechar</button>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div class="modal" id="adminModal">
  <div class="box">
    <h3>Administra√ß√£o</h3>

    <div class="admin-row">
      <select id="admCourse"></select>
      <input id="admCourseNew" placeholder="Novo curso">
    </div>

    <div class="admin-row">
      <select id="admMateria"></select>
      <input id="admMateriaNew" placeholder="Nova mat√©ria">
    </div>

    <div class="admin-row">
      <select id="admAssunto"></select>
      <input id="admAssuntoNew" placeholder="Novo assunto">
    </div>

    <div class="admin-row">
      <button class="btn" onclick="adminAdd()">Adicionar</button>
      <button class="btn-light" onclick="adminEdit()">Editar</button>
    </div>

    <div class="admin-row">
      <button class="btn-danger" onclick="adminDelAssunto()">Excluir Assunto</button>
      <button class="btn-danger" onclick="adminDelMateria()">Excluir Mat√©ria</button>
      <button class="btn-danger" onclick="adminDelCurso()">Excluir Curso</button>
    </div>

    <div style="text-align:right">
      <button class="btn-light" onclick="closeAdmin()">Fechar</button>
    </div>
  </div>
</div>

<script>
/* ================= BASE FUNCIONAL ================= */
const SHEET_ID="1eDylSUunRKeUXVq6lpJ8fbK4iFpK1WQgcPyEBAUEMf4";
const RANGE="dados!A:F"; // inclui ordem_materia
const ADMIN_EMAIL="kaiqueizaque2@gmail.com";

const token=localStorage.getItem("google_access_token");
const email=localStorage.getItem("user_email");

let rows=[],activeCourse=null,openMateria=null;
let flashRow=null,flashMatList=[],flashMatIndex=0;

const headers=()=>({Authorization:"Bearer "+token});

/* LOAD */
async function loadData(){
  const r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}`,{headers:headers()});
  const j=await r.json();
  rows=[];
  (j.values||[]).slice(1).forEach((v,i)=>{
    rows.push({
  rowIndex:i+2,
  curso:v[1],
  materia:v[2],
  assunto:v[3],
  flashcard:v[4]||"",
  status:Number(v[5])||0
});

  });
  render();
}

/* PROGRESSO GLOBAL */
function buildGlobalMap(){
  const map = {};
  rows.forEach(r=>{
    const k = r.curso+"::"+r.materia+"::"+r.assunto;
    map[k] = r.status;
  });
  return map;
}



/* RENDER */
function render(){
  courseList.innerHTML=""; subjectList.innerHTML="";
  const cursos={};
  rows.forEach(r=>{
    cursos[r.curso]??={};
    cursos[r.curso][r.materia]??=[];
    cursos[r.curso][r.materia].push(r);
  });

  Object.keys(cursos).forEach(c=>{
    const d=document.createElement("div");
    d.className="course"+(c===activeCourse?" active":"");
    d.textContent=c;
    d.onclick=()=>{activeCourse=c;openMateria=null;render()};
    courseList.appendChild(d);
  });

  if(!activeCourse) return;
  courseTitle.textContent=activeCourse;

  const global=buildGlobalMap();

  Object.entries(cursos[activeCourse])
    .forEach(([m,arr])=>{
      const keys = [...new Set(arr.map(a => a.curso+"::"+m+"::"+a.assunto))];
      const done = keys.reduce((s,k)=>{
  const st = global[k] ?? 0;
  return s + (st === 2 ? 1 : st === 1 ? 0.5 : 0);
}, 0);


      const pct=Math.round((done/keys.length)*100);

      const mat=document.createElement("div");
      mat.className="materia";
      mat.innerHTML=`
        <div class="materia-head">
          <div class="materia-left">
            <div class="materia-title">${m}</div>
            <div class="materia-meta">${keys.length} assuntos</div>
          </div>
          <div class="materia-right">
            <strong>${pct}%</strong>
            <button class="flash-btn" onclick="event.stopPropagation();openFlashMat('${m}')">üìò</button>          </div>
        </div>
      `;

      const as=document.createElement("div");
      as.className="assuntos"+(openMateria===m?" open":"");

      arr.forEach(o=>{
        const k = o.curso + "::" + o.materia + "::" + o.assunto;
        const st = global[k] ?? 0;

        const chk=document.createElement("div");
        chk.className = "check" + (st===2 ? " done" : st===1 ? " mid" : "");
        chk.textContent = st===2 ? "‚úì" : st===1 ? "‚Ä¢" : "";
        chk.onclick=(e)=>{
  e.stopPropagation();
  cycle(o);
};

        const f=document.createElement("button");
        f.className="flash-btn";
        f.textContent="üìù Flash Card";
        f.onclick=(e)=>{
  e.stopPropagation();
  openFlash(o);
};

        const row=document.createElement("div");
        row.className="assunto";
        row.append(chk,o.assunto,f);
        as.appendChild(row);
      });

      mat.querySelector(".materia-head").onclick=()=>{openMateria=openMateria===m?null:m;render()};
      mat.appendChild(as);
      subjectList.appendChild(mat);
    });

  updateChart(global);
}

/* PROGRESSO */
function cycle(o){
  o.status = o.status===0 ? 1 : o.status===1 ? 2 : 0;

  // üîπ atualiza visual imediato (SEM esperar reload)
  render();

  // üîπ salva em segundo plano
  saveAll();
}
async function saveAll(){
  await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?valueInputOption=USER_ENTERED`,
    {
      method:"PUT",
      headers:{...headers(),"Content-Type":"application/json"},
      body:JSON.stringify({
        values:[
          ["user_email","curso","materia","assunto","flashcard","status"],
...rows.map(r=>[email,r.curso,r.materia,r.assunto,r.flashcard,r.status])

        ]
      })
    }
  );
}


/* GR√ÅFICO */

function pesoStatus(st){
  return st === 2 ? 1 : st === 1 ? 0.5 : 0;
}

function animarNumero(el, inicio, fim, duracao = 400){
  const start = performance.now();

  function frame(agora){
    const progresso = Math.min((agora - start) / duracao, 1);
    const valor = Math.round(inicio + (fim - inicio) * progresso);
    el.textContent = valor + "%";
    if(progresso < 1) requestAnimationFrame(frame);
  }

  requestAnimationFrame(frame);
}

function updateChart(global){

  // üîµ CURSO ATIVO
  const cursoRows = rows.filter(r => r.curso === activeCourse);

  const cursoKeys = [...new Set(
    cursoRows.map(r => r.curso+"::"+r.materia+"::"+r.assunto)
  )];

  const cursoDone = cursoKeys.reduce((s,k)=>{
    return s + pesoStatus(global[k] ?? 0);
  }, 0);

  const pctCurso = cursoKeys.length
    ? Math.round((cursoDone / cursoKeys.length) * 100)
    : 0;

  // üîµ GERAL (TODOS OS CURSOS)
  const globalKeys = [...new Set(
    rows.map(r => r.curso+"::"+r.materia+"::"+r.assunto)
  )];

  const globalDone = globalKeys.reduce((s,k)=>{
    return s + pesoStatus(global[k] ?? 0);
  }, 0);

  const pctGlobal = globalKeys.length
    ? Math.round((globalDone / globalKeys.length) * 100)
    : 0;

  // üîµ ATUALIZA UI
  ringBar.style.strokeDashoffset = 326.7 * (1 - pctCurso / 100);
  const atual = parseInt(ringText.textContent) || 0;
animarNumero(ringText, atual, pctCurso);
  globalText.textContent = "Progresso geral: " + pctGlobal + "%";
}


/* FLASH */
function openFlash(o){flashRow=o;flashText.value=o.flashcard;flashModal.style.display="flex"}
function closeFlash(){flashModal.style.display="none"}
async function saveFlash(){flashRow.flashcard=flashText.value;await saveAll();closeFlash()}

function openFlashMat(m){
  flashMatList=rows.filter(r=>r.materia===m && r.flashcard);
  flashMatIndex=0;
  flashMatTitle.textContent="üìò Flash Cards ‚Äî "+m;
  renderFlashMat(); flashMatModal.style.display="flex"
}
function renderFlashMat(){
  flashMatText.textContent=flashMatList.length?flashMatList[flashMatIndex].flashcard:"Nenhum flash card."
}
function prevFlash(){if(flashMatIndex>0){flashMatIndex--;renderFlashMat()}}
function nextFlash(){if(flashMatIndex<flashMatList.length-1){flashMatIndex++;renderFlashMat()}}
function closeFlashMat(){flashMatModal.style.display="none"}

/* ADMIN */
function openAdmin(){
  if(email!==ADMIN_EMAIL){alert("Sem permiss√£o");return}
  adminModal.style.display="flex"; populateAdmin()
}
function closeAdmin(){adminModal.style.display="none"}

function populateAdmin(){
  const cursos=[...new Set(rows.map(r=>r.curso))];
  admCourse.innerHTML=cursos.map(c=>`<option>${c}</option>`).join("");
  updateAdmMateria();
}
function updateAdmMateria(){
  const mats=[...new Set(rows.filter(r=>r.curso===admCourse.value).map(r=>r.materia))];
  admMateria.innerHTML=mats.map(m=>`<option>${m}</option>`).join("");
  updateAdmAssunto();
}
function updateAdmAssunto(){
  const as=[...new Set(rows.filter(r=>r.curso===admCourse.value && r.materia===admMateria.value).map(r=>r.assunto))];
  admAssunto.innerHTML=as.map(a=>`<option>${a}</option>`).join("");
}
admCourse.onchange=updateAdmMateria;
admMateria.onchange=updateAdmAssunto;

async function adminAdd(){
  if(admAssuntoNew.value){
    rows.push({curso:admCourse.value,materia:admMateria.value,assunto:admAssuntoNew.value,flashcard:"",status:0,ordem:999});
  }else if(admMateriaNew.value){
    rows.push({curso:admCourse.value,materia:admMateriaNew.value,assunto:"",flashcard:"",status:0,ordem:999});
  }else if(admCourseNew.value){
    rows.push({curso:admCourseNew.value,materia:"",assunto:"",flashcard:"",status:0,ordem:999});
  }
  await saveAll(); populateAdmin()
}

async function adminEdit(){
  if(admAssuntoNew.value){
    rows.forEach(r=>{if(r.assunto===admAssunto.value)r.assunto=admAssuntoNew.value})
  }else if(admMateriaNew.value){
    rows.forEach(r=>{if(r.materia===admMateria.value)r.materia=admMateriaNew.value})
  }else if(admCourseNew.value){
    rows.forEach(r=>{if(r.curso===admCourse.value)r.curso=admCourseNew.value})
  }
  await saveAll(); populateAdmin()
}

async function adminDelAssunto(){
  rows=rows.filter(r=>r.assunto!==admAssunto.value);
  await saveAll(); populateAdmin()
}
async function adminDelMateria(){
  rows=rows.filter(r=>r.materia!==admMateria.value);
  await saveAll(); populateAdmin()
}
async function adminDelCurso(){
  rows=rows.filter(r=>r.curso!==admCourse.value);
  await saveAll(); populateAdmin()
}


loadData();

function logout(){
  localStorage.removeItem("google_access_token");
  localStorage.removeItem("user_email");
  location.replace("index.html");
}


</script>

</body>
</html>